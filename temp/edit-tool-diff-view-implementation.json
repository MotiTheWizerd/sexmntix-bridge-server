{
  "task": "edit-tool-diff-view-implementation",
  "date": "2025-10-16",
  "component": "edit-tool-diff-view",
  "tags": [
    "diff-view",
    "vscode-diff-api",
    "edit-tool",
    "virtual-documents",
    "dom-preservation",
    "validator-optional-fields",
    "javascript-truthiness-bug",
    "innerHTML-attribute-loss",
    "debugging",
    "root-cause-analysis"
  ],
  "summary": "Implemented VSCode diff view for Edit tool clicks - shows before/after comparison when clicking Edit tool file names, while Read/Write tools open files normally",
  "problem": "Need to show visual diff comparison when users click on Edit tool file names in the UI, to see what changed (before ↔ after). Read/Write tools should continue opening files normally.",
  "solution": "Created complete data flow from backend → UI → VSCode diff API, but encountered THREE critical bugs during implementation that required deep debugging and root cause analysis.",
  "keyLearnings": [
    {
      "title": "innerHTML Wipes ALL Data Attributes",
      "lesson": "When you set element.innerHTML, ALL data attributes are lost. The ToolElementUpdater was updating content on tool.use.end, wiping the diff data attributes set on tool.use.start.",
      "gotcha": "Even though we carefully set data-old-content, data-new-content, data-tool-name on tool.use.start, they were completely lost when tool.use.end fired and updated element.innerHTML with result content.",
      "solution": "Preserve attributes BEFORE innerHTML update, restore AFTER. This pattern is crucial anytime you update innerHTML on elements with important data attributes.",
      "codePattern": "const attr = el.getAttribute('data-x'); el.innerHTML = newContent; if (attr) el.setAttribute('data-x', attr);"
    },
    {
      "title": "JavaScript && Operator Returns Last Truthy Value",
      "lesson": "const x = a && b && c returns the LAST truthy value (c), NOT true. This caused showDiff to be a string instead of boolean.",
      "gotcha": "const showDiff = toolName === 'Edit' && oldContent && newContent; When all are truthy, this returns newContent (string 'hello world'), not true.",
      "solution": "Force boolean conversion: const showDiff = !!(toolName === 'Edit' && oldContent && newContent);",
      "codePattern": "Use !! to force boolean: const bool = !!(condition && value);"
    },
    {
      "title": "BridgeEventValidator Doesn't Understand Optional Fields",
      "lesson": "The validator iterates ALL schema fields and validates them, even optional ones marked with ?. It doesn't skip validation for missing optional fields.",
      "gotcha": "Schema: { 'oldContent?': 'string' } - Validator checks if payload.oldContent is string, fails on undefined even though field is optional.",
      "solution": "Check if field ends with ?, strip the ?, skip validation if optional AND undefined: if (isOptional && actualValue === undefined) continue;",
      "codePattern": "const isOptional = field.endsWith('?'); const fieldName = isOptional ? field.slice(0, -1) : field;"
    },
    {
      "title": "Deep Debugging: Trace Data Flow End-to-End",
      "lesson": "When a feature doesn't work, trace the COMPLETE data flow from source to destination. Don't assume - verify each step.",
      "process": [
        "1. Check backend: Does ConversationBuilder preserve old_string/new_string? YES ✓",
        "2. Check events: Does ChatToolStartPayload include params? YES ✓",
        "3. Check UI storage: Does ToolDOMBuilder set attributes? YES ✓",
        "4. Check UI retrieval: Does ToolClickHandler read attributes? Logs show string content! ❌",
        "5. Why? Trace element lifecycle: tool.use.start sets attrs → tool.use.end updates innerHTML → ATTRS LOST!",
        "6. Root cause found: ToolElementUpdater.performUpdate() wipes attributes"
      ],
      "takeaway": "Systematic tracing reveals root causes. Look at logs carefully - 'showDiff: hello worldhello moti' was the smoking gun."
    }
  ],
  "implementation": {
    "dataFlow": [
      "1. Claude sends tool_use: { name: 'Edit', input: { old_string, new_string, file_path } }",
      "2. ConversationBuilder.processToolUse() preserves diff data in toolInfo.params",
      "3. ChatToolStartPayload sent to UI with params: { oldContent, newContent, toolName }",
      "4. ToolDOMBuilder.assembleToolElement() stores in DOM: data-old-content, data-new-content, data-tool-name",
      "5. tool.use.end fires → ToolElementUpdater PRESERVES attributes before innerHTML update, RESTORES after",
      "6. User clicks file → ToolClickHandler reads attributes, detects Edit tool, sends diff request",
      "7. Extension UIEventHandlers receives request → DiffService.showDiff()",
      "8. VSCode shows diff view: Left (before) ↔ Right (after)"
    ],
    "filesCreated": [
      {
        "file": "src/ext/ui-host-components/editor/DiffService.ts",
        "purpose": "Service for showing VSCode diff views using vscode.diff command and virtual documents"
      },
      {
        "file": "src/ext/ui-host-components/editor/VirtualDocumentProvider.ts",
        "purpose": "Provides in-memory documents for diff view (before/after content)"
      }
    ],
    "filesModified": [
      {
        "file": "src/ext/modules/providers/base/ExtensionTypes.ts",
        "changes": "Added oldContent, newContent, toolName to ToolParams interface"
      },
      {
        "file": "src/ext/modules/providers/shared/parsers/ConversationBuilder.ts",
        "changes": "Preserve Edit tool old_string/new_string in params, pass to tool_use_end"
      },
      {
        "file": "src/shared/events/chat.ts",
        "changes": "Updated ChatToolStartPayload with diff fields (oldContent, newContent, toolName)"
      },
      {
        "file": "src/shared/events/bridge.ts",
        "changes": "Updated FileOpenRequestedPayload with diff fields (oldContent, newContent, showDiff)"
      },
      {
        "file": "src/shared/contracts/transport.json",
        "changes": "Added optional fields to file.open.requested.v1 schema"
      },
      {
        "file": "src/ext/ui-host-components/editor/index.ts",
        "changes": "Exported DiffService and VirtualDocumentProvider"
      },
      {
        "file": "src/ext/activation.ts",
        "changes": "Initialize DiffService at extension startup"
      },
      {
        "file": "src/ext/modules/logic-manager/handlers/UIEventHandlers.ts",
        "changes": "Detect showDiff flag, call DiffService.showDiff() instead of EditorService.openFile()"
      },
      {
        "file": "src/ui/modules/ui-logic/ui-controllers/chat-controller/tool-manager/renderer/dom/ToolDOMBuilder.js",
        "changes": "Store diff data in DOM attributes (data-old-content, data-new-content, data-tool-name)"
      },
      {
        "file": "src/ui/modules/ui-logic/ui-controllers/chat-controller/tool-manager/handlers/ToolClickHandler.js",
        "changes": "Detect Edit tools, read diff attributes, send diff request with !! boolean conversion"
      },
      {
        "file": "src/ui/modules/ui-logic/ui-controllers/chat-controller/tool-manager/renderer/updater/ToolElementUpdater.js",
        "changes": "CRITICAL FIX: Preserve diff attributes before innerHTML update, restore after"
      },
      {
        "file": "src/shared/events/validator.ts",
        "changes": "Handle optional fields (strip ?, skip validation if optional and undefined)"
      }
    ]
  },
  "architecturePrinciples": {
    "providerAgnostic": "Uses universal conversation format - works with any provider (Claude, Codex, future providers)",
    "eventDriven": "Flows through existing event pipeline - no new event types needed",
    "backwardCompatible": "All changes additive - Read/Write tools continue working normally",
    "singleResponsibility": "DiffService handles diffs, EditorService handles files, VirtualDocumentProvider handles in-memory docs",
    "gracefulDegradation": "Falls back to normal file open if diff data unavailable or VSCode diff fails"
  },
  "testingChecklist": [
    "✅ Edit tool click shows VSCode diff view (before ↔ after)",
    "✅ Write tool click opens file normally (no diff)",
    "✅ Read tool click opens file normally (no diff)",
    "✅ No validation errors in console",
    "✅ Diff attributes preserved after tool.use.end update",
    "✅ showDiff is proper boolean (true/false) not string",
    "✅ Optional fields accepted by validator"
  ],
  "debugging": {
    "criticalClues": [
      "Log showed: 'showDiff: hello worldhello motihello world 3' - This was a STRING, not boolean!",
      "This revealed TWO bugs: (1) && returns last truthy value, (2) Attributes contain file content not original input",
      "Traced why: tool.use.end innerHTML update was wiping attributes set on tool.use.start"
    ],
    "debuggingProcess": [
      "1. Saw validation errors - fixed ToolClickHandler to only send fields when present",
      "2. Still had validation errors - realized validator doesn't handle optional fields",
      "3. Fixed validator, then saw showDiff was a string - fixed boolean logic",
      "4. BUT attributes still had wrong data - traced element lifecycle",
      "5. Found innerHTML wipes attributes - fixed ToolElementUpdater to preserve/restore",
      "6. SUCCESS - all three bugs fixed!"
    ]
  },
  "uxBehavior": {
    "editTool": "Click file name → VSCode diff view opens (left: before, right: after, title: 'filename - Edit Changes')",
    "writeTool": "Click file name → File opens normally in editor",
    "readTool": "Click file name → File opens normally in editor",
    "fallback": "If diff data missing or VSCode diff fails → opens file normally with error logged"
  },
  "totalFiles": "14 files (2 new, 12 modified)",
  "complexity": "High - required deep understanding of: VSCode diff API, virtual document providers, DOM attribute lifecycle, JavaScript truthiness, event validation, data flow tracing",
  "impact": "MAJOR UX IMPROVEMENT - Users can now visually see what Edit tools changed without manually comparing before/after"
}
