{
  "task": "tool-start-action-specific-payload-migration",
  "agent": "claude-sonnet-4-5",
  "date": "2025-11-03",
  "component": "tool-event-streaming-architecture",

  "temporal_context": {
    "date_iso": "2025-11-03",
    "year": 2025,
    "month": 11,
    "week_number": 44,
    "quarter": "2025-Q4",
    "time_period": "recent"
  },

  "complexity": {
    "technical": "4: Streaming timing coordination, registry pattern, event emission orchestration",
    "business": "3: Completes action-specific payload architecture for consistent tool visualization",
    "coordination": "4: Required understanding of tool_end pattern, streaming flow, and timing constraints"
  },

  "files_modified": "4",
  "files_touched": [
    "src/shared/events/chat.ts",
    "src/ext/modules/logic-manager/message-router/events/StreamEventEmitter.ts",
    "src/ext/modules/logic-manager/message-router/streaming/ToolParamStreamHandler.ts",
    "src/ext/modules/logic-manager/message-router/streaming/processor/processing/ToolUseProcessor.ts",
    "src/ext/modules/logic-manager/message-router/MessageRouter.ts"
  ],
  "tests_added": "0",
  "related_tasks": [
    "tool-result-action-specific-backend-refactor-complete",
    "read-tool-filepath-streaming-params-fix",
    "tool-result-timing-fix-complete",
    "ui-action-specific-formatter-migration"
  ],

  "outcomes": {
    "performance_impact": "No impact - emission timing changed but processing unchanged",
    "test_coverage_delta": "0%",
    "technical_debt_reduced": "high",
    "follow_up_needed": "false"
  },

  "summary": "tool_start.v1 showing empty params (pattern: '.') instead of complete params (pattern: '*.html') due to streaming timing race condition â†’ Moved tool_start emission from ToolUseProcessor to ToolParamStreamHandler, mirroring tool_end pattern",

  "root_cause": "Streaming timing race condition - tool_use content block arrives before input_json_delta chunks, so params are empty when ToolUseProcessor emits tool_start. Params get populated later by ToolParamStreamHandler but tool_start already sent.",

  "solution": {
    "approach": "Mirror tool_end architecture - wait for complete data before emitting. ToolParamStreamHandler emits tool_start when params are parsed (like ToolResultProcessor emits tool_end when result arrives)",
    "key_changes": [
      "chat.ts: Added 4 action-specific START payload interfaces (SearchActionStartPayload, ReadActionStartPayload, WriteActionStartPayload, EditActionStartPayload)",
      "chat.ts: Updated ChatToolStartPayload with action-specific fields and deprecated legacy fields",
      "StreamEventEmitter.ts: Enhanced createToolStartPayload() with action-specific logic (mirroring createToolEndPayload pattern)",
      "ToolUseProcessor.ts: Removed emitToolStart() call - now just stores in registry and updates state",
      "ToolParamStreamHandler.ts: Added StreamEventEmitter dependency injection and toolStartEmitted Set tracker",
      "ToolParamStreamHandler.ts: Emit tool_start when params complete (after JSON parsing in processChunk)",
      "MessageRouter.ts: Pass streamEventEmitter to ToolParamStreamHandler constructor"
    ]
  },

  "validation": "Build succeeded. Tool_start payload now shows complete params with correct pattern after reload",

  "gotchas": [
    {
      "issue": "Initial approach tried fixing fallback logic in createToolStartPayload (pattern: toolInfo.params?.pattern || target.path) but params were still empty",
      "solution": "Root cause was timing - params arrive AFTER tool_use. Fixed by delaying emission until ToolParamStreamHandler accumulates params (Option 4 from analysis)",
      "category": "integration",
      "severity": "high"
    },
    {
      "issue": "Import path error: './events/StreamEventEmitter' instead of '../events/StreamEventEmitter' in ToolParamStreamHandler",
      "solution": "Fixed relative path - StreamEventEmitter is one directory up from streaming/",
      "category": "configuration",
      "severity": "low"
    },
    {
      "issue": "TypeScript error: StoredToolInfo doesn't have toolId property",
      "solution": "toolId is the Map key in ToolMapRegistry, not part of StoredToolInfo interface. Use toolId parameter directly instead of existingTool.toolId",
      "category": "typing",
      "severity": "medium"
    }
  ],

  "lesson": "Streaming timing race conditions require architectural coordination - can't fix with fallback logic alone. Must wait for complete data before emitting events. Mirroring existing patterns (tool_end) ensures consistency and predictability.",

  "tags": [
    "tool-start",
    "streaming-timing",
    "action-specific-payloads",
    "registry-coordination",
    "event-emission",
    "input_json_delta",
    "params-accumulation",
    "architectural-symmetry",
    "COMPLETE"
  ],

  "code_context": {
    "key_patterns": [
      "ToolParamStreamHandler.processChunk() - Accumulates input_json_delta chunks, parses JSON, updates registry, emits tool_start when complete",
      "StreamEventEmitter.createToolStartPayload() - Builds action-specific nested payloads from params (search/read/write/edit)",
      "toolStartEmitted Set - Tracks which tools have emitted tool_start to prevent duplicates",
      "ToolUseProcessor.process() - Stores tool in registry but no longer emits (delegates to ToolParamStreamHandler)"
    ],
    "api_surface": [
      "ChatToolStartPayload.search?: SearchActionStartPayload - Nested search params (pattern, searchPath)",
      "ChatToolStartPayload.read?: ReadActionStartPayload - Nested read params (filePath)",
      "ChatToolStartPayload.write?: WriteActionStartPayload - Nested write params (filePath, content)",
      "ChatToolStartPayload.edit?: EditActionStartPayload - Nested edit params (filePath, oldText, newText)",
      "ToolParamStreamHandler.processChunk(toolId, partialJson) - Accumulates params and emits tool_start when ready"
    ],
    "dependencies_added": [],
    "breaking_changes": [
      "ChatToolStartPayload.target and .params now optional (deprecated) - use action-specific fields instead",
      "tool_start emission timing changed - now fires after params complete instead of immediately on tool_use"
    ]
  },

  "future_planning": {
    "next_logical_steps": [
      "Update UI formatters to consume new nested tool_start payloads (search.pattern instead of params.pattern)",
      "Add bash execute action-specific payload for consistency",
      "Consider emitting progress updates during param accumulation for long-streaming tools"
    ],
    "architecture_decisions": {
      "option-4-delayed-emission": "Chose to move emission to ToolParamStreamHandler (Option 4) instead of accepting empty params (Option 3) or dual emission (Option 2) - mirrors tool_end pattern perfectly",
      "registry-coordination": "Both ToolParamStreamHandler and ToolResultProcessor update registry then emit events - single source of truth pattern",
      "action-specific-symmetry": "tool_start and tool_end now have identical action-specific nested structure - consistent mental model"
    },
    "extension_points": [
      "ToolParamStreamHandler.processChunk() - Add new action types here when adding tool support",
      "StreamEventEmitter.createToolStartPayload() - Add new action-specific payload builders matching tool_end pattern",
      "chat.ts - Define new ActionStartPayload interfaces for new tool types"
    ]
  },

  "user_context": {
    "development_style": "staged-testing",
    "naming_preferences": "technical-precise",
    "architecture_philosophy": "event-driven",
    "quality_standards": "maintainability-focus"
  },

  "semantic_context": {
    "domain_concepts": [
      "streaming-timing-race-condition",
      "registry-coordination",
      "event-emission-orchestration",
      "action-specific-payloads"
    ],
    "technical_patterns": [
      "orchestrator-pattern",
      "registry-pattern",
      "delayed-emission-pattern",
      "dependency-injection"
    ],
    "integration_points": [
      "input_json_delta-chunks",
      "ToolMapRegistry",
      "StreamEventEmitter"
    ]
  }
}
