{
  "task": "model-selection-event-and-user-session-settings-plan",
  "agent": "claude-sonnet-4-5",
  "date": "2025-11-13",
  "component": "model-selection-event-system",

  "temporal_context": {
    "date_iso": "2025-11-13",
    "year": 2025,
    "month": 11,
    "week_number": 46,
    "quarter": "2025-Q4",
    "time_period": "recent"
  },

  "complexity": {
    "technical": "2: Event system integration with per-chat state management",
    "business": "3: Enables per-chat model selection and session-isolated settings",
    "coordination": "2: Required coordination between UI dropdown and Extension ChatInstance"
  },

  "files_modified": "5",
  "files_touched": [
    "src/ui/modules/ui-logic/core/events/categories/chat/ChatEventConstants.js",
    "src/ui/modules/ui-logic/providers/data/ProviderRegistry.js",
    "src/ui/modules/ui-logic/ui-controllers/chat-controller/user-ui/UserUIController.js",
    "src/ui/modules/ui-logic/ui-controllers/chat-controller/user-ui/coordination/ChatTabCoordinator.js",
    "src/ui/modules/ui-logic/ui-controllers/chat-controller/user-ui/options-dropdown/OptionsDropdownOrchestrator.js"
  ],
  "tests_added": "0",
  "related_tasks": [
    "three-choice-permission-system-per-chat-session",
    "proactive-permission-system-per-session-implementation",
    "provider-models-dropdown-dynamic-population"
  ],

  "outcomes": {
    "performance_impact": "No impact",
    "test_coverage_delta": "0%",
    "technical_debt_reduced": "medium",
    "follow_up_needed": "true"
  },

  "summary": "Added CHAT_MODEL_CHANGED event emission when user selects model + planned UserSessionSettings component for per-chat model persistence → Event fires with full context (modelId, modelName, providerId, chatId), ready for Extension to store in ChatInstance.UserSessionSettings",

  "root_cause": "Model dropdown existed but no event notification system to communicate model changes to Extension for per-chat storage",

  "solution": {
    "approach": "Follow CHAT_PROVIDER_SELECTED pattern: emit event from UI dropdown, plan Extension ChatInstance component to store preference",
    "key_changes": [
      "ChatEventConstants.js: Added CHAT_MODEL_CHANGED event constant and payload type mapping",
      "ProviderRegistry.js: Updated Claude model IDs to correct values (claude-sonnet-4-5, claude-haiku-4-5, claude-opus-4-1)",
      "UserUIController.js: Injected chatTabCoordinator into OptionsDropdownController constructor",
      "ChatTabCoordinator.js: Added getChatStore() pass-through method for accessing per-chat data",
      "OptionsDropdownOrchestrator.js: Added event emission in handleMenuItemClick with full payload (modelId, modelName, providerId, chatId, timestamp)"
    ]
  },

  "validation": "Event fires correctly with all required fields, providerId correctly retrieved from ChatStore per-chat state",

  "gotchas": [
    {
      "issue": "Initial providerId showed as 'unknown' because we used providersUIManager.getActiveProvider() which returns global state (null in per-chat architecture)",
      "solution": "Used existing pattern from PlaceholderCreator: chatTabCoordinator.getChatStore().get(chatId)?.providerId - accesses per-chat state from ChatStore",
      "category": "integration",
      "severity": "medium"
    },
    {
      "issue": "Initially added custom getActiveProviderId() method to ChatTabCoordinator, creating unnecessary abstraction",
      "solution": "Removed custom method, added simple getChatStore() pass-through instead, using existing pattern: chatStore.get(chatId)?.providerId",
      "category": "architecture",
      "severity": "low"
    }
  ],

  "lesson": "ALWAYS search for existing patterns before adding new methods. PlaceholderCreator and provider indicator already use chatStore.get(chatId)?.providerId pattern. Follow established patterns, avoid adding junk code.",

  "tags": [
    "model-selection",
    "CHAT_MODEL_CHANGED",
    "event-emission",
    "per-chat-state",
    "session-settings",
    "ChatInstance",
    "AllowedToolsTracker-pattern",
    "micro-components",
    "ultra-modular",
    "INCOMPLETE"
  ],

  "code_context": {
    "key_patterns": [
      "chatStore.get(chatId)?.providerId - Per-chat provider access pattern (used by PlaceholderCreator, provider indicator)",
      "chatInstance.addAllowedTool(toolType) - Per-chat permission storage pattern",
      "eventBus.emit(UI_EVENTS.CHAT_MODEL_CHANGED, payload) - Event emission pattern",
      "chatTabCoordinator.getChatStore() - Pass-through for per-chat data access"
    ],
    "api_surface": [
      "UI_EVENTS.CHAT_MODEL_CHANGED: 'chat.model.changed' - Event constant for model selection",
      "handleMenuItemClick(optionId) - Emits event with payload { modelId, modelName, providerId, chatId, timestamp }",
      "chatTabCoordinator.getChatStore(): ChatStore|null - Access to per-chat data store",
      "chatStore.get(chatId): Chat|null - Get chat object with providerId, sessionId, etc."
    ],
    "dependencies_added": [],
    "breaking_changes": []
  },

  "future_planning": {
    "next_logical_steps": [
      "Create UserSessionSettings.ts micro-component in src/ext/modules/logic-manager/chat-instance/components/session/",
      "Add UserSessionSettings to ChatInstance initialization (session subsystem)",
      "Expose getSelectedModel() and setSelectedModel() public API on ChatInstance",
      "Create Extension event listener for CHAT_MODEL_CHANGED to store model in ChatInstance",
      "Wire selected model to CLI arguments when starting conversation"
    ],
    "architecture_decisions": {
      "session_subsystem_location": "UserSessionSettings belongs in session/ subsystem alongside AllowedToolsTracker - both store per-chat user preferences",
      "micro_component_pattern": "Follow AllowedToolsTracker structure: private field, constructor with chatId, getter/setter methods, toJSON/fromJSON for serialization",
      "event_driven_sync": "UI emits CHAT_MODEL_CHANGED → Extension listens → ChatInstance stores → CLI uses stored model"
    },
    "extension_points": [
      "ChatInstance - Add userSessionSettings component to session subsystem (line ~69)",
      "MessageRouter or similar - Listen to CHAT_MODEL_CHANGED event and call chatInstance.setSelectedModel()",
      "CLI argument builders - Read chatInstance.getSelectedModel() when building CLI args"
    ]
  },

  "user_context": {
    "development_style": "staged-testing",
    "naming_preferences": "technical-precise",
    "architecture_philosophy": "ultra-modular-micro-components",
    "quality_standards": "maintainability-focus"
  },

  "semantic_context": {
    "domain_concepts": [
      "per-chat-model-selection",
      "session-isolated-settings",
      "user-preferences",
      "model-persistence"
    ],
    "technical_patterns": [
      "micro-component-architecture",
      "session-subsystem-pattern",
      "event-driven-state-sync",
      "ChatInstance-orchestrator"
    ],
    "integration_points": [
      "UI-EventBus",
      "Extension-ChatInstanceManager",
      "CLI-argument-building"
    ]
  },

  "implementation_plan": {
    "phase_1_completed": {
      "description": "UI event emission for model selection",
      "files": [
        "ChatEventConstants.js - Event constant added",
        "ProviderRegistry.js - Model IDs updated",
        "OptionsDropdownOrchestrator.js - Event emission implemented"
      ],
      "status": "COMPLETE"
    },
    "phase_2_next_session": {
      "description": "Extension ChatInstance UserSessionSettings component",
      "steps": [
        {
          "step": 1,
          "action": "Create UserSessionSettings.ts",
          "location": "src/ext/modules/logic-manager/chat-instance/components/session/UserSessionSettings.ts",
          "pattern": "Copy AllowedToolsTracker.ts structure",
          "code_template": {
            "class_name": "UserSessionSettings",
            "private_field": "private model: string | null = null",
            "methods": [
              "getModel(): string | null",
              "setModel(modelId: string): void",
              "clearModel(): void",
              "toJSON(): { model: string | null }",
              "fromJSON(data: { model?: string }): void"
            ]
          }
        },
        {
          "step": 2,
          "action": "Integrate into ChatInstance",
          "location": "src/ext/modules/logic-manager/chat-instance/ChatInstance.ts",
          "changes": [
            "Import UserSessionSettings (line ~7)",
            "Add private readonly userSessionSettings: UserSessionSettings (line ~49)",
            "Initialize in constructor: this.userSessionSettings = new UserSessionSettings(chatId) (line ~69)",
            "Add public API: getSelectedModel() → this.userSessionSettings.getModel()",
            "Add public API: setSelectedModel(modelId) → this.userSessionSettings.setModel(modelId)"
          ]
        },
        {
          "step": 3,
          "action": "Create Extension event listener",
          "approach": "Find where Extension listens to UI events, add CHAT_MODEL_CHANGED handler",
          "logic": [
            "Get chatId from payload",
            "Get ChatInstance: chatInstanceManager.getInstance(chatId)",
            "Store model: chatInstance.setSelectedModel(payload.modelId)",
            "Log: '[Extension] Model changed for chat {chatId}: {modelId}'"
          ]
        },
        {
          "step": 4,
          "action": "Wire to CLI arguments",
          "approach": "When building CLI args, read chatInstance.getSelectedModel() and pass to --model flag",
          "location": "Find CLI argument builder (ClaudeArgsBuilder or similar)"
        }
      ]
    }
  },

  "architecture_insights": {
    "chatinstance_structure": {
      "subsystems": [
        "session/ - SessionTracker, SessionStateSync, AllowedToolsTracker, UserSessionSettings (NEW)",
        "provider/ - ProviderTracker",
        "history/ - MessageStore, MessageOperations",
        "metadata/ - TimestampTracker, TitleManager",
        "diagnostics/ - SnapshotBuilder, StateResetter"
      ],
      "pattern": "Each subsystem contains focused micro-components with single responsibility",
      "initialization": "All components initialized in ChatInstance constructor with dependency injection"
    },
    "session_isolation_pattern": {
      "description": "Each ChatInstance maintains its own session-specific state",
      "examples": [
        "AllowedToolsTracker - per-chat tool permissions",
        "UserSessionSettings - per-chat user preferences (NEW)",
        "SessionTracker - per-chat sessionId",
        "ProviderTracker - per-chat providerId"
      ],
      "benefit": "Tab 1 and Tab 2 can have completely different settings, permissions, and state"
    },
    "per_chat_access_pattern": {
      "ui_side": "chatTabCoordinator.getChatStore().get(chatId) → access ChatStore per-chat data",
      "extension_side": "chatInstanceManager.getInstance(chatId) → access ChatInstance per-chat data",
      "consistency": "Both sides maintain per-chat isolation through manager lookup by chatId"
    }
  }
}
